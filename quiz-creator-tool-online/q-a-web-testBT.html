<!--
File: q-a-web-testB.html
Contract: EU contract 2022-FR01-KA220-HED-000023509
Project: FitNESS 2 ERASMUS+
File Created: Monday, 16th October 2023
Author: Steward OUADI
-----
Last Modified: Monday, 23rd October 2023
Modified By: Steward OUADI
-->



<html>
<!-- Test for beginners - designed by Olivier Vitrac - rev. $ 2020-12-04 $ -->

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FITNess test</title>
  <link type="text/css" rel="stylesheet" href="src/quiz.css" />
</head>

<body>
  <div id="submit-results-proposal">
    <button id="submit-results">Submit results by email</button>
    <p>By clicking on the button above, you will send your answers to the creator of this quiz.</p>
  </div>
  <!-- <label for="fileInput" class="custom-file-label">Import questions</label> -->
  <!-- <input type="file" id="fileInput" accept=".md" onchange="convertQuestions()"> -->



  <!-- <button style="padding: 1px; position:unset;" onclick="convertQuestions()">Show questions</button> -->
  <pre id="output"></pre>
  <h1>
    <table>
      <tr>
        <td>
          <img src="src/Fitness2_logo.png" referrerpolicy="no-referrer" alt="FITNESS" title="ERASMUS+ Project" class=""
            width="128px" height="" />
        </td>
        <td>ERASMUS+ programme (contract 2022-FR01-KA220-HED-000023509)</td>
      </tr>
    </table>
  </h1>
  <div id="qbutton">
    <button id="previous"></button>
    <button id="next"></button>
    <button id="submit"></button>
  </div>
  <div id="results"></div>
  <div class="quiz-container">
    <div id="quiz">
      <p>Click on the "Browse" button to import the Markdown file containing your questions and display them using the
        FITNESS quiz format.
      </p>
    </div>

  </div>


  <!-- Include libraries -->
  <script src="src/libraries/math.js" type="text/javascript"></script>
  <script src="src/utils.js" type="text/javascript"></script>

  <!-- Include classes -->
  <script src="src/GlobalSlide.js"></script>
  <script src="src/RadioButtonQuizSlide.js"></script>
  <script src="src/SuggestionMenuSlide.js"></script>
  <script src="src/CheckBoxButtonQuizSlide.js"></script>
  <script src="src/ImageOnlySlide.js"></script>



  <!-- config.js: used to get configuration -->
  <!-- <script src="src/config.js"></script> -->

  <script src="../../src/js/utils.js"></script>
  <script type="text/javascript" src="src/beginner.js"></script>
  <script type="text/javascript" src="src/markdownContentVars.js"></script>


  <script>
    let currentFilename = "";

    displaySendResultsByEmailButtonIfNecessary();

    function generateIdentifier() {
      var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var identifier = '';

      for (var i = 0; i < 5; i++) {
        var randomIndex = Math.floor(Math.random() * characters.length);
        identifier
          += characters.charAt(randomIndex);
      }
      return identifier;
    }

    const defaultSessionIdentifier = generateIdentifier();

    var markdownVariableToRead = window.location.hash.substring(1);
    console.log("substr beg");
    console.log(markdownVariableToRead);
    console.log(markdownVariableToRead.trim() !== "");
    console.log("substr end");

    function questionsFromURL() {
      // If variable is not empty, use it to read markdown
      if (markdownVariableToRead.trim() !== "") {

        var markdownContent = window[markdownVariableToRead];
        console.log(testA);
        var lines = markdownContent.split('\n');
        // var lines = event.target.result.split('\n');
        processMarkdownContent(lines);
      }

    }

    function convertQuestions() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      if (!file) {
        alert('Please select a file');
        return;
      }

      currentFilename = file.name;

      const reader = new FileReader();
      reader.onload = (event) => {
        var lines = event.target.result.split('\n');
        processMarkdownContent(lines);
      };
      reader.readAsText(file);
    }

    function processMarkdownContent2(content) {
      let isMultiChoice = false;
      let isEmail = false;
      const lines = content.trim().split('\n');

      const configurationData = [];

      // Add the global configuration at the beginning
      configurationData.push({
        id: 'global',
        shuffleAnswers: false,
        currentScore: 0,
      });

      let currentQuestion = null;
      let answerIndex = 'a';
      let correctAnswer = []; // Initialize the correctAnswer array

      lines.forEach((line) => {
        const trimmedLine = line.trim();

        if (trimmedLine === 'canBeSentByEmail:true') {
          isEmail = true;
        } else if (trimmedLine.startsWith('Q')) {
          if (isMultiChoice) {
            // Only include the correctAnswer array if there are correct answers
            if (correctAnswer.length > 0) {
              currentQuestion.correctAnswer = correctAnswer;
              configurationData.push(currentQuestion);
            }
          }

          isMultiChoice = true;
          const questionText = trimmedLine.split(': ')[1]; // Extract the question text
          currentQuestion = {
            id: 'quest-' + (configurationData.length),
            question: {
              text: `${trimmedLine}: ${questionText}`, // Include "QX" in question.text
            },
            answers: {},
            minimumPassedScore: 0,
            pointsIfCorrectAnswer: 1,
            pointsIfWrongAnswer: 0,
          };
          answerIndex = 'a'; // Initialize answerIndex
          correctAnswer = []; // Initialize correctAnswer array
        } else if (trimmedLine.startsWith('- [x]')) {
          if (!isMultiChoice) {
            return;
          }
          const answerText = trimmedLine.replace('- [x]', '').trim();
          currentQuestion.answers[answerIndex] = {
            text: answerText,
          };
          correctAnswer.push(answerIndex); // Add to correctAnswer array
          answerIndex = String.fromCharCode(answerIndex.charCodeAt(0) + 1);
        } else if (trimmedLine.startsWith('- [ ]')) {
          if (!isMultiChoice) {
            return;
          }
          const answerText = trimmedLine.replace('- [ ]', '').trim();
          currentQuestion.answers[answerIndex] = {
            text: answerText,
          };
          answerIndex = String.fromCharCode(answerIndex.charCodeAt(0) + 1);
        }
      });

      if (isMultiChoice) {
        // Only include the correctAnswer array if there are correct answers
        if (correctAnswer.length > 0) {
          currentQuestion.correctAnswer = correctAnswer;
          configurationData.push(currentQuestion);
        }
      }

      if (isEmail) {
        // Handle email-specific data if needed.
      }

      return configurationData;
    }


    function processMarkdownContent(lines) {

      const configurationData = [];

      const globalSlide = {
        id: "global",
        shuffleAnswers: false,
        currentScore: 0,
      };

      configurationData.push(globalSlide);

      let currentQuestion = null;
      let answerIndex = 'a';

      lines.forEach((line) => {
        line = line.trim();

        if (line.startsWith('Q')) {
          if (currentQuestion !== null) {
            configurationData.push(currentQuestion);
          }
          currentQuestion = {
            id: line.split(':')[0].trim(),
            question: {
              text: line.split(':')[1].trim(),
            },
            answers: {},
            pointsIfCorrectAnswer: 1,
            pointsIfWrongAnswer: 0,
          };
          answerIndex = 'a';
        } else if (line.startsWith('-')) {
          const isCorrect = line.startsWith('- [x]');
          // const answerText = line.slice(5).trim();
          const answerText = line.split(']')[1].trim();

          currentQuestion.answers[answerIndex] = {
            text: answerText
          };
          if (isCorrect) {
            currentQuestion.correctAnswer = answerIndex;
          }
          answerIndex = String.fromCharCode(answerIndex.charCodeAt(0) + 1);
        } else if (line.startsWith('canBeSentByEmail')) {
          canBeSentByEmail = line.split(':')[1].trim();
        }
      });

      if (currentQuestion !== null) {
        configurationData.push(currentQuestion);
      }

      const result = `const configurationData = ${JSON.stringify(configurationData, null, 2)};`;
      const quizContainer = document.getElementById("quiz");
      quizContainer.innerHTML = "";
      // allSlides = configurationData;
      /* allSlides = [{
           id: "global",
           shuffleAnswers: false,
           currentScore: [0],
         },
         {
           id: "quest-1",
           question: {
             text: "Q1: Which of these statements are generally true for professionals in your field?",
           },
           answers: {
             a: {
               text: "Able to interpret laws",
             },
             b: {
               text: "All opinions on dangers are equally valid",
             },
             c: {
               text: "Can consult authorities for advice",
             },
             d: {
               text: "Committed to continuous learning",
             },
             e: {
               text: "Acts to preserve consumer and environmental safety",
             },
           },
           correctAnswer: ["a", "c", "d", "e"],
           next: {
             specific: "quest-2",
           },

           minimumPassedScore: [0],
           pointsIfCorrectAnswer: [1],
           pointsIfWrongAnswer: [0],
         },
         {
           id: "quest-2",
           question: {
             text: "Q2: How would you characterize the role of regulation in your industry?",
           },
           answers: {
             a: {
               text: "A hindrance to trade",
             },
             b: {
               text: "An administrative necessity",
             },
             c: {
               text: "Transfers responsibility to society",
             },
             d: {
               text: "Establishes common-sense rules",
             },
             e: {
               text: "Less effective than industry standards",
             },
           },
           correctAnswer: ["b", "c", "d"],
           next: {
             specific: "quest-3",
           },

           minimumPassedScore: [0],
           pointsIfCorrectAnswer: [1],
           pointsIfWrongAnswer: [0],
         },
         {
           id: "quest-3",
           question: {
             text: "Q3: Which of the following statements about plastic waste and recycling are true?",
           },
           answers: {
             a: {
               text: "Plastic waste has doubled in the last 20 years",
             },
             b: {
               text: "Current regulations encourage environmentally unfriendly practices",
             },
             c: {
               text: "Objectives for recyclability increase risks",
             },
             d: {
               text: "Some contaminants are nearly everlasting",
             },
             e: {
               text: "Recycled plastics often cost more than new materials",
             },
           },
           correctAnswer: ["a", "c", "d", "e"],
           next: {
             specific: "quest-4",
           },

           minimumPassedScore: [0],
           pointsIfCorrectAnswer: [1],
           pointsIfWrongAnswer: [0],
         },
         {
           id: "quest-4",
           question: {
             text: "Q4: Which of these statements are generally true regarding certification and compliance?",
           },
           answers: {
             a: {
               text: "Online certification is possible",
             },
             b: {
               text: "Compliance certificates cannot usually be printed online",
             },
             c: {
               text: "Calculations can demonstrate packaging compliance",
             },
             d: {
               text: "Authorities organize product recalls in case of contamination",
             },
             e: {
               text: "Paper and cardboard have specific regulations at the EU level",
             },
           },
           correctAnswer: ["a", "c", "d", "e"],
           next: {
             specific: "quest-5",
           },

           minimumPassedScore: [0],
           pointsIfCorrectAnswer: [1],
           pointsIfWrongAnswer: [0],
         },
         {
           id: "quest-5",
           question: {
             text: "Q5: Which statements about chemical risks and packaging are true?",
           },
           answers: {
             a: {
               text: "A preventive approach to chemical risks is common",
             },
             b: {
               text: "The migration of substances is usually invisible and odorless",
             },
             c: {
               text: "Thresholds for unknown substances are often immeasurable",
             },
             d: {
               text: "Many substances in recycled materials have not been toxicologically evaluated",
             },
             e: {
               text: "Packaging can be a significant source of polyaromatic hydrocarbons",
             },
           },
           correctAnswer: ["b", "c", "d", "e"],

           minimumPassedScore: [0],
           pointsIfCorrectAnswer: [1],
           pointsIfWrongAnswer: [0],
         }
       ];*/
      const sortieA = processMarkdownContent2(testA);
      const sortieC = processMarkdownContent2(testC);
      const sortieD = processMarkdownContent2(testD);

      console.log("sorties A et B beg")
      console.log(sortieA); // Converted data for entreeA
      console.log(sortieC); // Converted data for entreeB
      console.log(sortieD); // Converted data for entreeB
      console.log(JSON.stringify(sortieD, undefined, 2))
      console.log("sorties A et B end")

      allSlides = sortieC;
      /*allSlides = [{
          "id": "global",
          "shuffleAnswers": false,
          "currentScore": 0
        },
        {
          "id": "quest-1",
          "question": {
            "text": "What is your stance on food packaging?"
          },
          "answers": {
            "a": {
              "text": "Neutral"
            }
          },
          "correctAnswer": [
            "a"
          ],
          "minimumPassedScore": [
            0
          ],
          "pointsIfCorrectAnswer": [
            1
          ],
          "pointsIfWrongAnswer": [
            0
          ],
          "next": {
            "specific": "quest-2"
          }
        },
        {
          "id": "quest-2",
          "question": {
            "text": "How many key functions are typically served by packaging?"
          },
          "answers": {
            "a": {
              "text": "Seven (Examples: Containment, Protection, Communication, Convenience, Portion Control, Freshness Preservation, Security)"
            }
          },
          "correctAnswer": [
            "a"
          ],
          "minimumPassedScore": [
            0
          ],
          "pointsIfCorrectAnswer": [
            1
          ],
          "pointsIfWrongAnswer": [
            0
          ],
          "next": {
            "specific": "quest-3"
          }
        }, {
          "id": "quest-3",
          "question": {
            "text": "What roles does packaging assume in relation to food safety risks?"
          },
          "answers": {
            "a": {
              "text": "Risk Mitigation"
            },
            "b": {
              "text": "Risk Introduction"
            }
          },
          "correctAnswer": [
            "a",
            "b"
          ],
          "minimumPassedScore": [
            0
          ],
          "pointsIfCorrectAnswer": [
            1
          ],
          "pointsIfWrongAnswer": [
            0
          ],
          "next": {
            "specific": "quest-4"
          }
        }, {
          "id": "quest-4",
          "question": {
            "text": "Identify the categories of food contact materials sanctioned in Europe."
          },
          "answers": {
            "a": {
              "text": "Plastics, Paper, Metals"
            },
            "b": {
              "text": "Glass, Ceramics"
            },
            "c": {
              "text": "Silicones, Paraffin waxes"
            },
            "d": {
              "text": "Elastomers and rubbers"
            },
            "e": {
              "text": "Timber"
            }
          },
          "correctAnswer": [
            "a",
            "b",
            "c",
            "d",
            "e"
          ],
          "minimumPassedScore": [
            0
          ],
          "pointsIfCorrectAnswer": [
            1
          ],
          "pointsIfWrongAnswer": [
            0
          ],
          "next": {
            "specific": "quest-5"
          }
        }, {
          "id": "quest-5",
          "question": {
            "text": "Why do plastics predominate in food packaging?"
          },
          "answers": {
            "a": {
              "text": "Consumer Acceptance"
            },
            "b": {
              "text": "Cost-Effectiveness"
            },
            "c": {
              "text": "Lightweight"
            },
            "d": {
              "text": "Recyclability"
            }
          },
          "correctAnswer": [
            "a",
            "b",
            "c",
            "d"
          ],
          "minimumPassedScore": [
            0
          ],
          "pointsIfCorrectAnswer": [
            1
          ],
          "pointsIfWrongAnswer": [
            0
          ],
          "next": {
            "specific": "quest-6"
          }
        }, {
          "id": "quest-6",
          "question": {
            "text": "What materials are suitable for hot filling (above 80°C)?"
          },
          "answers": {
            "a": {
              "text": "PS"
            },
            "b": {
              "text": "PP"
            }
          },
          "correctAnswer": [
            "a",
            "b"
          ],
          "minimumPassedScore": [
            0
          ],
          "pointsIfCorrectAnswer": [
            1
          ],
          "pointsIfWrongAnswer": [
            0
          ],
          "next": {
            "specific": "quest-7"
          }
        }, {
          "id": "quest-7",
          "question": {
            "text": "What scope does European regulation encompass in the context of food packaging?"
          },
          "answers": {
            "a": {
              "text": "Both materials and substances"
            }
          },
          "correctAnswer": [
            "a"
          ],
          "minimumPassedScore": [
            0
          ],
          "pointsIfCorrectAnswer": [
            1
          ],
          "pointsIfWrongAnswer": [
            0
          ],
          "next": {
            "specific": "quest-8"
          }
        }, {
          "id": "quest-8",
          "question": {
            "text": "Which agencies primarily oversee food contact material safety?"
          },
          "answers": {
            "a": {
              "text": "BfR (Germany)"
            },
            "b": {
              "text": "DGCCRF (France)"
            },
            "c": {
              "text": "FDA (USA)"
            }
          },
          "correctAnswer": [
            "a",
            "b",
            "c"
          ],
          "minimumPassedScore": [
            0
          ],
          "pointsIfCorrectAnswer": [
            1
          ],
          "pointsIfWrongAnswer": [
            0
          ],
          "next": {
            "specific": "quest-9"
          }
        }, {
          "id": "quest-9",
          "question": {
            "text": "Which organizations are principally responsible for regulating food packaging waste?"
          },
          "answers": {
            "a": {
              "text": "ECHA (EU)"
            },
            "b": {
              "text": "EPA (USA)"
            }
          },
          "correctAnswer": [
            "a",
            "b"
          ],
          "minimumPassedScore": [
            0
          ],
          "pointsIfCorrectAnswer": [
            1
          ],
          "pointsIfWrongAnswer": [
            0
          ],
          "next": {
            "specific": "quest-10"
          }
        }, {
          "id": "quest-10",
          "question": {
            "text": "What impending regulatory shifts are projected in France by 2025, potentially influencing EU policies?"
          },
          "answers": {
            "a": {
              "text": "Advisories against plastic-packaged food for pregnant women"
            },
            "b": {
              "text": "Mandatory endocrine disruptor labeling"
            },
            "c": {
              "text": "Limitation on virgin material usage"
            },
            "d": {
              "text": "No reheating of children's cafeteria food in plastic containers"
            },
            "e": {
              "text": "Ban on mineral oils in print media"
            },
            "f": {
              "text": "Influence of recycled material quality on food shelf life"
            },
            "g": {
              "text": "Condition-based utilization of carcinogenic substances for food contact"
            }
          },
          "correctAnswer": [
            "a",
            "b",
            "c",
            "d",
            "e",
            "f",
            "g"
          ],
          "minimumPassedScore": [
            0
          ],
          "pointsIfCorrectAnswer": [
            1
          ],
          "pointsIfWrongAnswer": [
            0
          ]
        }
      ];*/
      DoQuiz();
      // document.getElementById('output').textContent = result;
    }





    questionsFromURL();
    document.getElementById("submit-results").addEventListener("click", function () {
      var popup = window.open("", "popup", "width=400,height=300");

      var popupContent = "<h2>Send results by email</h2>" +
        "<label for='input-id'>Pseudonym or first/last name: (you can change it to write your own)</label>" +
        "<input type='text' id='input-id' value='" + defaultSessionIdentifier + "'>" +
        "<button id='btn-send'>Send</button>";

      popup.document.write(popupContent);

      // popup.document.getElementsByTagName("form")[0].addEventListener("submit", function (event) {
      //   event.preventDefault();
      // });
      var btnSend = popup.document.getElementById("btn-send");
      popup.document.getElementById("btn-send").addEventListener("click", function () {
        var sessionIdentifier = popup.document.getElementById("input-id").value;
        console.log("first click")
        // Perform necessary actions to send the results via email

        console.log("clicked on send");
        var recipient1 = "olivier.vitrac@agroparistech.fr";
        var recipient2 = "steward.ouadi@agroparistech.fr";
        var title = markdownVariableToRead;
        var identifier = sessionIdentifier;
        var subject = encodeURIComponent(title + "|" + identifier);
        var content = encodeURIComponent(JSON.stringify(questionsAndUserAnswers, undefined, 2));

        var mailtoLink = "mailto:" + recipient1 + "," + recipient2 + "?subject=" + subject +
          "&body=" +
          content;

        // var mailtoLink = "mailto:" + recipient2 + "?subject=" + subject +
        //   "&body=" +
        //   content;
        // var mailtoLink = "mailto:" + recipient + "?subject=" + subject + "&body=" + content;


        window.location.href = mailtoLink;


        popup.close();
      });



      // Prevent the default form submission behavior when pressing Enter
      popup.document.onkeydown = function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          return false;
        }
      };
    });
  </script>




</body>

</html>